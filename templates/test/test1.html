<!DOCTYPE html>
<html>
    <head>
        <title>Emotion Recognition System</title>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
        <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.4/dist/jquery.slim.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
        <script src="https://www.WebRTC-Experiment.com/MediaStreamRecorder.js"></script>
    </head>
<body>
    <nav class="navbar navbar-dark bg-dark">
        <a class="navbar-brand" href="#">Emotion Recognition Systems</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarsExample01" aria-controls="navbarsExample01" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
      
        <div class="collapse navbar-collapse" id="navbarsExample01">
          <ul class="navbar-nav mr-auto">
            <li class="nav-item active">
              <a class="nav-link" href="#">Home <span class="sr-only">(current)</span></a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#">Link</a>
            </li>
            <li class="nav-item">
              <a class="nav-link disabled" href="#">Disabled</a>
            </li>
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" id="dropdown01" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Dropdown</a>
              <div class="dropdown-menu" aria-labelledby="dropdown01">
                <a class="dropdown-item" href="#">Action</a>
                <a class="dropdown-item" href="#">Another action</a>
                <a class="dropdown-item" href="#">Something else here</a>
              </div>
            </li>
          </ul>
          <form class="form-inline my-2 my-md-0">
            <input class="form-control" type="text" placeholder="Search" aria-label="Search">
          </form>
        </div>
      </nav>

      <div class="container mt-3">
        <h3>Upload File</h3>
        <p>Choose a recording and upload it here:</p>
        <form action="/statics/uploads">
          <p>Recording:</p>
          <div class="custom-file mb-3">
            <input type="file" class="custom-file-input" id="customFile" name="filename">
            <label class="custom-file-label" for="customFile">Choose file</label>
          </div>
        
          <div class="mt-3">
            <button type="submit" class="btn btn-primary">Submit</button>
          </div>
        </form>
        <div class="mt-3">
          <h3>Record Audio</h3>
          <p>Press the button to start recording. Press again to stop:</p>
          <button id="recordButton" class="btn btn-primary">Start Recording</button>
        </div>
        
      </div>
    
    <div class="images">
        {% if waveplot %}
        <div class="image">
            <h2>Waveplot</h2>
            <img src="/{{ waveplot }}" alt="Waveplot" class="img-fluid">
        </div>
        {% endif %}

        {% if spectrogram %}
        <div class="image">
            <h2>Spectrogram</h2>
            <img src="/{{ spectrogram }}" alt="Spectrogram" class="img-fluid">
        </div>
        {% endif %}
    </div>

    <!-- Show the audio player -->
    {% if audio %}
        <h2>Audio</h2>
        <audio controls class="w-100">
            <source src="/{{ audio }}" type="audio/wav">
            Your browser does not support the audio element.
        </audio>
    {% endif %}

    {% if sentence %}
    <h2>Transcribed Text</h2>
    <p>{{ sentence }}</p>
    {% endif %}

    {% if sinhala_sentence %}
    <h2>Sinhala Transcription</h2>
    <p>{{ sinhala_sentence }}</p>
    {% endif %}
    
    {% if emotion %}
        <h2>Caller Emotion</h2>
        <p>{{ emotion }}</p>
    {% endif %}
    
    {% if department %}
        <h2>Connecting to Department</h2>
        <p>{{ department }}</p>
    {% endif %}
    
    #provide an code to record audio form mic and send it to server for processing

    <!-- Bootstrap JS, Popper.js, and jQuery -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // Code with improvements

      let recordButton = document.getElementById('recordButton');
      let mediaStream, recorder;

    recordButton.addEventListener("click", function() {
      if(recorder && recorder.recording) {
      recorder.stop();
      recorder = null;

    recordButton.textContent = "Start Recording";
    recordButton.classList.remove("btn-danger");
    recordButton.classList.add("btn-primary");

    if (mediaStream && mediaStream.getAudioTracks()[0]) {
      mediaStream.getAudioTracks()[0].stop();
    } else {
      console.log('Error: no media stream track found');
    }
  } else {
    navigator.mediaDevices.getUserMedia({ audio: true })
      .then(function(stream) {
        mediaStream = stream;
        recorder = new MediaStreamRecorder(mediaStream);
        recorder.mimeType = 'audio/wav';
        recorder.audioChannels = 1;
        recorder.start();

        recorder.onstop = function() {
          sendAudioTo(recorder.blob);
        };

        recordButton.textContent = "Stop Recording";
        recordButton.classList.remove("btn-primary");
        recordButton.classList.add("btn-danger");
        recorder.recording = true;
      })
      .catch(function(err) {
        console.log('Error starting recording:', err);
      });
  }
});

function sendAudioToServer(blob) {
  let formData = new FormData();
  formData.append('audio', blob, 'audio.wav');
  
  fetch('/get-voice', { method: 'POST', body: formData })
    .then(response => response.json())
    .then(data => {
      console.log(data);
      // Update the page with the response data
    })
    .catch(console.error);
}
  </script>
</body>
</html>



<!-- HANDLE THE BUTTON CLICK TO MAKE A REQUEST TO SAVE TO A CSV FILE -->
<script>
  function saveResolveIncidentData() {
    const transcribedText =
      document.getElementById("transcribed-text").value;
    const departmentText = document.getElementById("department-text").value;

    const data = {
      transcribedText: transcribedText,
      department: departmentText, // Adding departmentText to the JSON object
    };

    fetch("/save-to-csv", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify(data),
    })
      .then((response) => {
        if (response.ok) {
          alert("Text saved to CSV successfully!");
        } else {
          alert("Error saving text to CSV.");
        }
      })
      .catch((error) => {
        console.error("Error:", error);
      });
  }
</script>